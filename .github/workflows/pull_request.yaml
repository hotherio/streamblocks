name: Pull Request Validation

on:
  pull_request:
    branches:
    - main
    - develop
    types:
    - opened
    - edited
    - synchronize
    - reopened

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.13", "3.14"]
      fail-fast: false

    steps:
    # PR title check (safe - no shell interpolation of untrusted input)
    - name: Check PR Title
      uses: amannn/action-semantic-pull-request@48f256284bd46cdaab1048c3721360e808335d50 # v6
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        types: |
          feat
          fix
          docs
          style
          refactor
          perf
          test
          build
          ci
          chore
          revert
        requireScope: false
        subjectPattern: ^[a-z].+[^.]$
        validateSingleCommit: true

    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

    - name: Setup Python and uv
      uses: ./.github/actions/setup-python-uv
      with:
        python-version: ${{ matrix.python-version }}
        dependency-groups: all

    - name: Install lefthook binary
      run: npm install -g @evilmartians/lefthook

    - name: Install lefthook
      run: |
        source .venv/bin/activate
        lefthook install

    - name: Lint
      run: |
        source .venv/bin/activate
        lefthook run pre-commit --all-files

    - name: Tests
      run: uv run -m pytest

  validate-docs:
    name: Validate Docs
    runs-on: ubuntu-24.04

    steps:
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

    - name: Setup Python and uv
      uses: ./.github/actions/setup-python-uv
      with:
        dependency-groups: doc

    - name: Build docs
      run: |
        source .venv/bin/activate
        mkdocs build
